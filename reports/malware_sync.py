import requests
import re
import json

VS_CODE_URL = 'https://raw.githubusercontent.com/microsoft/vsmarketplace/refs/heads/main/RemovedPackages.md'
REGEX = r'^(\|)(.+)(\|)(.+)(\|)(.+)(\|*)$'
OPEN_VSX_EXTENSIONS_FILENAME = 'namespaces_and_extensions_names.json'

ovsx_extensions_file = open(OPEN_VSX_EXTENSIONS_FILENAME, 'r')
ovsx_extensions = json.load(ovsx_extensions_file)
ovsx_extensions_file.close()
ovsx_extension_names_dict = ovsx_extensions[0]
ovsx_extension_names = list(ovsx_extension_names_dict.keys())
ovsx_namespaces = ovsx_extensions[1]

response = requests.get(VS_CODE_URL)
response.raise_for_status()
contents = response.text.splitlines()

vscode_malware = []
start = False
for line in contents:
    concatenation = line.find('||')
    if concatenation != -1:
        first_half = line[:concatenation+1]
        match = re.search(REGEX, first_half)
        if match:
            vscode_malware.append((match.group(2).strip(),match.group(6).replace('|', '').strip()))
        second_half = line[concatenation+1:]
        match = re.search(REGEX, second_half)
        if match:
            vscode_malware.append((match.group(2).strip(),match.group(6).replace('|', '').strip()))
    else:
        match = re.search(REGEX, line)
        if match:
            if not start:
                if '----------' in match.group(2):
                    start = True
            else:
                vscode_malware.append((match.group(2).strip(),match.group(6).replace('|', '').strip()))
namespace_matches = []
extension_name_matches = []
for entry in vscode_malware:
    vscode_extension_id = entry[0]
    vscode_reason = entry[1]
    vscode_publisher, vscode_name = vscode_extension_id.split('.')
    ovsx_namespace_match = ovsx_namespaces.get(vscode_publisher)
    if ovsx_namespace_match:
        print(f"Namespace match {vscode_reason}: {vscode_extension_id} - {ovsx_namespace_match}")
        namespace_matches.append(ovsx_namespace_match)
    else:
        if vscode_name in ovsx_extension_names:
            print(f"Extension name match {vscode_reason}: {vscode_extension_id}")
            extension_name_matches.append(vscode_extension_id)

print(f"Number of malware entries: {len(vscode_malware)}")
print(f"Number of namespace matches: {len(namespace_matches)}")
print(f"Number of extension name matches: {len(extension_name_matches)}")


